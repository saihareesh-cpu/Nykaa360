<!DOCTYPE html>
<html>
<head>
  <title>360 Feedback â€“ FY26</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { 
      font-family: Arial; 
      max-width: 800px; 
      margin: 40px auto; 
    }
    h2 { text-align: center; }
    input, button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
    }
    select { 
      width: 100%; 
      height: 200px; 
      margin-top: 15px;
    }
    .hidden { display: none; }
  </style>
</head>

<body>

<h2>Welcome to 360Â° Feedback â€“ FY26</h2>

<div id="loginSection">
  <input type="email" id="email" placeholder="Enter your corporate email">
  <button onclick="login()">Send OTP</button>
</div>

<div id="dashboardSection" class="hidden">

  <h3 id="welcomeText"></h3>

  <div id="nominationSection">
    <p>Select minimum 5 and maximum 7 employees:</p>
    <select multiple id="employeeSelect"></select>
    <button onclick="submitNomination()">Submit Nomination</button>
  </div>

  <div id="lockedMessage" class="hidden">
    <h4>Your nomination has been submitted and locked.</h4>
  </div>

</div>

<script>

  // ðŸ”´ REPLACE THESE TWO VALUES
  const SUPABASE_URL = "PASTE_YOUR_PROJECT_URL";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;

  // LOGIN FUNCTION
  window.login = async function() {

    const email = document.getElementById("email").value;

    if (!email) {
      alert("Please enter email.");
      return;
    }

    const { error } = await supabaseClient.auth.signInWithOtp({
      email: email,
      options: {
        emailRedirectTo: window.location.origin
      }
    });

    if (error) {
      console.error(error);
      alert("Error sending OTP.");
    } else {
      alert("OTP sent. Check your email.");
    }
  }

  // HANDLE LOGIN SESSION
  supabaseClient.auth.onAuthStateChange(async (event, session) => {

    if (session) {
      currentUser = session.user;

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("dashboardSection").classList.remove("hidden");

      loadDashboard();
    }
  });

  // LOAD DASHBOARD
  async function loadDashboard() {

    const { data: employee } = await supabaseClient
      .from('employees')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (!employee) {
      alert("Employee record not found.");
      return;
    }

    document.getElementById("welcomeText").innerText =
      "Welcome " + employee.name;

    const { data: nominations } = await supabaseClient
      .from('nominations')
      .select('*')
      .eq('nominator_id', employee.id);

    if (nominations && nominations.length > 0) {
      document.getElementById("nominationSection").classList.add("hidden");
      document.getElementById("lockedMessage").classList.remove("hidden");
      return;
    }

    loadEmployees(employee.id);
  }

  // LOAD EMPLOYEE LIST
  async function loadEmployees(selfId) {

    const { data } = await supabaseClient
      .from('employees')
      .select('id,name,designation');

    const select = document.getElementById("employeeSelect");

    select.innerHTML = "";

    data.forEach(emp => {
      if (emp.id !== selfId) {
        let option = document.createElement("option");
        option.value = emp.id;
        option.text = emp.name + " - " + emp.designation;
        select.appendChild(option);
      }
    });
  }

  // SUBMIT NOMINATION
  async function submitNomination() {

    const selected = Array.from(
      document.getElementById("employeeSelect").selectedOptions
    );

    if (selected.length < 5 || selected.length > 7) {
      alert("Select between 5 and 7 employees.");
      return;
    }

    const { data: employee } = await supabaseClient
      .from('employees')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    for (let option of selected) {

      await supabaseClient.from('nominations').insert([{
        nominator_id: employee.id,
        nominee_id: option.value,
        cycle_name: 'FY26'
      }]);

      await supabaseClient.from('assignments').insert([{
        employee_id: employee.id,
        reviewer_id: option.value,
        unique_token: crypto.randomUUID()
      }]);
    }

    alert("Nomination Submitted Successfully.");
    location.reload();
  }

</script>

</body>
</html>
