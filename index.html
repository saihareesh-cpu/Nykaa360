<!DOCTYPE html>
<html>
<head>
  <title>360 Feedback – FY26</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 40px auto; }
    h2 { text-align: center; }
    button { padding: 10px; margin-top: 10px; }
    select { width: 100%; height: 150px; }
    .hidden { display:none; }
  </style>
</head>
<body>

<h2>Welcome to 360° Feedback – FY26</h2>

<div id="loginSection">
  <input type="email" id="email" placeholder="Enter your corporate email">
  <button onclick="login()">Send OTP</button>
</div>

<div id="dashboardSection" class="hidden">

  <h3 id="welcomeText"></h3>

  <div id="nominationSection">
    <p>Select minimum 5 and maximum 7 employees:</p>

    <select multiple id="employeeSelect"></select>

    <button onclick="submitNomination()">Submit Nomination</button>
  </div>

  <div id="lockedMessage" class="hidden">
    <h4>Your nomination has been submitted and locked.</h4>
  </div>

</div>

<script>

  const SUPABASE_URL = "PASTE_YOUR_PROJECT_URL";
  const SUPABASE_ANON_KEY = ""sb_publishable_4Co6mEpJZlKA2R6rnEBbjQ_pPDLPF9h"";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;

  async function login() {
    const email = document.getElementById("email").value;

    await supabase.auth.signInWithOtp({

    alert("Check your email for OTP link.");
  }

  supabase.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      currentUser = session.user;
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("dashboardSection").classList.remove("hidden");

      loadDashboard();
    }
  });

  async function loadDashboard() {
    const { data: employee } = await supabase
      .from('employees')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    document.getElementById("welcomeText").innerText =
      "Welcome " + employee.name;

    const { data: nominations } = await supabase
      .from('nominations')
      .select('*')
      .eq('nominator_id', employee.id);

    if (nominations.length > 0) {
      document.getElementById("nominationSection").classList.add("hidden");
      document.getElementById("lockedMessage").classList.remove("hidden");
      return;
    }

    loadEmployees(employee.id);
  }

  async function loadEmployees(selfId) {
    const { data } = await supabase
      .from('employees')
      .select('id,name,designation');

    const select = document.getElementById("employeeSelect");

    data.forEach(emp => {
      if (emp.id !== selfId) {
        let option = document.createElement("option");
        option.value = emp.id;
        option.text = emp.name + " - " + emp.designation;
        select.appendChild(option);
      }
    });
  }

  async function submitNomination() {
    const selected = Array.from(
      document.getElementById("employeeSelect").selectedOptions
    );

    if (selected.length < 5 || selected.length > 7) {
      alert("Select between 5 and 7 employees.");
      return;
    }

    const { data: employee } = await supabase
      .from('employees')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    for (let option of selected) {
      await supabase.from('nominations').insert([{
        nominator_id: employee.id,
        nominee_id: option.value,
        cycle_name: 'FY26'
      }]);

      await supabase.from('assignments').insert([{
        employee_id: employee.id,
        reviewer_id: option.value,
        unique_token: crypto.randomUUID()
      }]);
    }

    alert("Nomination Submitted Successfully.");
    location.reload();
  }

</script>

</body>
</html>
