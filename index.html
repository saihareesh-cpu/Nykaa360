<!DOCTYPE html>
<html>
<head>
  <title>Nykaa Leadership 360 Feedback</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial;
      max-width: 650px;
      margin: 40px auto;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }
    select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: black;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
    }
    .success {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h2>Nykaa Leadership 360 Feedback</h2>
<div id="leaderName"></div>

<form id="feedbackForm">

  <label>1. Customer Obsession</label>
  <select required id="customer">
    <option value="">Select Rating</option>
    <option value="1">1 - Needs Improvement</option>
    <option value="2">2</option>
    <option value="3">3 - Meets Expectations</option>
    <option value="4">4</option>
    <option value="5">5 - Role Model</option>
  </select>

  <label>2. Ownership & Accountability</label>
  <select required id="ownership">
    <option value="">Select Rating</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>3. Agility & Speed</label>
  <select required id="agility">
    <option value="">Select Rating</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>4. Collaboration</label>
  <select required id="collaboration">
    <option value="">Select Rating</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>5. Innovation & Problem Solving</label>
  <select required id="innovation">
    <option value="">Select Rating</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>6. Integrity & Values</label>
  <select required id="integrity">
    <option value="">Select Rating</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label>Biggest Strength</label>
  <textarea required id="strength"></textarea>

  <label>Top Development Area</label>
  <textarea required id="improvement"></textarea>

  <button type="submit">Submit Feedback</button>

</form>

<script>

  const SUPABASE_URL = "https://rmtlqloytdawcxtzatfi.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_4Co6mEpJZlKA2R6rnEBbjQ_pPDLPF9h";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  async function loadAssignment() {

    if (!token) {
      document.body.innerHTML = "<h2>Invalid Link</h2>";
      return;
    }

    const { data: assignment } = await supabaseClient
      .from('assignments')
      .select('*')
      .eq('unique_token', token)
      .single();

    if (!assignment || assignment.submitted) {
      document.body.innerHTML = "<h2>Link expired or already submitted.</h2>";
      return;
    }

    const { data: employee } = await supabaseClient
      .from('employees')
      .select('name')
      .eq('id', assignment.employee_id)
      .single();

    if (employee) {
      document.getElementById("leaderName").innerHTML =
        "<strong>Leader: </strong> " + employee.name;
    }
  }

  loadAssignment();

  document.getElementById("feedbackForm")
    .addEventListener("submit", async (e) => {

      e.preventDefault();

      const { data: assignment } = await supabaseClient
        .from('assignments')
        .select('*')
        .eq('unique_token', token)
        .single();

      await supabaseClient.from('feedback').insert([{
        assignment_id: assignment.id,
        rating_customer_focus: document.getElementById("customer").value,
        rating_ownership: document.getElementById("ownership").value,
        rating_agility: document.getElementById("agility").value,
        rating_collaboration: document.getElementById("collaboration").value,
        rating_innovation: document.getElementById("innovation").value,
        rating_integrity: document.getElementById("integrity").value,
        comment_strength: document.getElementById("strength").value,
        comment_improvement: document.getElementById("improvement").value
      }]);

      await supabaseClient
        .from('assignments')
        .update({ submitted: true })
        .eq('unique_token', token);

      document.body.innerHTML =
        "<div class='success'>Thank you. Feedback submitted successfully.</div>";
    });

</script>

</body>
</html>
